<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusFlow</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f0f11',
                        neon: '#00f3ff'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #0f0f11;
            color: white;
            overflow-x: hidden; /* 防止水平滚动 */
        }

        /* 隐藏 Lightbox 初始状态，交由 GSAP 控制 */
        #lightbox {
            visibility: hidden;
            opacity: 0;
        }

        #gallery { position: relative; }
        .grid-item { position: absolute; width: 0; margin-bottom: 0; opacity: 0; will-change: transform; }

        .img-container {
            transform-style: preserve-3d;
            transition: transform 0.3s ease-out;
        }
        .img-container:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 243, 255, 0.2);
            z-index: 10;
        }

        /* 骨架屏动画 */
        .skeleton {
            background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="antialiased">

    <nav class="fixed top-0 w-full z-50 backdrop-blur-xl bg-black/60 border-b border-white/10 py-4 px-6 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-neon rounded-full animate-pulse shadow-[0_0_10px_#00f3ff]"></div>
            <h1 class="text-xl font-bold tracking-widest">NEXUS<span class="text-neon">FLOW</span></h1>
        </div>
        <div id="status-indicator" class="text-[10px] text-neon font-mono border border-neon/30 px-2 py-1 rounded">
            SYSTEM READY
        </div>
    </nav>

    <main class="container mx-auto px-4 pt-24 pb-10 min-h-screen flex flex-col">
        <!-- 瀑布流容器 -->
        <div id="gallery" class="w-full relative">
            <div class="grid-sizer hidden"></div>
        </div>
        
        <!-- 加载动画 -->
        <div id="loader" class="w-full py-12 flex flex-col justify-center items-center transition-opacity duration-300 opacity-0">
            <div class="w-10 h-10 border-4 border-neon border-t-transparent rounded-full animate-spin"></div>
            <span class="mt-3 text-xs text-gray-500 font-mono">FETCHING DATA STREAMS...</span>
        </div>

        <!-- 哨兵元素：当滚动到这里时触发加载 -->
        <div id="sentinel" class="w-full h-10"></div>
    </main>

    <!-- Lightbox (全屏查看) -->
    <div id="lightbox" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-sm flex justify-center items-center p-4">
        <!-- 关闭按钮 -->
        <button id="close-btn" class="absolute top-6 right-6 text-white/50 hover:text-neon transition-colors z-50 p-2">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <div class="relative max-w-7xl w-full h-full flex flex-col items-center justify-center">
            <img id="lightbox-img" src="" class="max-h-[85vh] max-w-full object-contain rounded-lg shadow-[0_0_100px_-20px_rgba(0,243,255,0.3)]" alt="">
            
            <!-- 信息条 -->
            <div class="mt-6 flex items-center gap-6 bg-white/5 border border-white/10 px-8 py-3 rounded-full backdrop-blur-md">
                <div class="text-left">
                    <p class="text-[10px] text-gray-400 uppercase">Source</p>
                    <p id="lightbox-api" class="text-neon font-bold font-mono text-sm">API</p>
                </div>
                <div class="w-px h-8 bg-white/10"></div>
                <div class="text-left">
                    <p class="text-[10px] text-gray-400 uppercase">Resolution</p>
                    <p id="lightbox-dim" class="text-white font-mono text-sm">Size</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JS 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="wallpaper.js"></script>

    <script>
        // --- 配置 ---
        const CONFIG = {
            batchSize: 12,    // 每次加载数量
            gutter: 24,       // 间距
        };

        // 状态变量
        let isLoading = false;
        let columns = 0;
        let colHeights = [];
        let colLefts = [];
        let columnWidth = 0;

        // 使用聚合抓取函数 fetchWallpapers（来自 wallpaper.js）替代所有单一图片 API

        const grid = document.querySelector('#gallery');
        function computeColumns(){
            const w = grid.clientWidth;
            const cols = w < 768 ? 2 : (w < 1280 ? 3 : 5);
            if(cols === columns && columnWidth) return;
            columns = cols;
            columnWidth = Math.floor((w - CONFIG.gutter*(columns-1)) / columns);
            colHeights = new Array(columns).fill(0);
            colLefts = [];
            for(let i=0;i<columns;i++){ colLefts[i] = i*(columnWidth + CONFIG.gutter); }
        }
        function placeItem(el){
            el.style.width = columnWidth + 'px';
            el.style.position = 'absolute';
            const h = el.offsetHeight;
            let idx = 0; let min = colHeights[0];
            for(let i=1;i<columns;i++){ if(colHeights[i] < min){ min = colHeights[i]; idx = i; } }
            el.style.transform = 'translate('+colLefts[idx]+'px,'+min+'px)';
            colHeights[idx] = min + h + CONFIG.gutter;
            grid.style.height = Math.max.apply(null,colHeights) + 'px';
        }
        function layoutNew(items){
            computeColumns();
            for(let i=0;i<items.length;i++){ placeItem(items[i]); }
        }
        function layoutAll(){
            computeColumns();
            colHeights = new Array(columns).fill(0);
            const items = Array.prototype.slice.call(grid.querySelectorAll('.grid-item'));
            for(let i=0;i<items.length;i++){ placeItem(items[i]); }
        }
        window.__imgLoaded = function(img){
            const item = img.closest('.grid-item');
            if(item){
                const cont = item.querySelector('.img-container');
                if(cont) cont.style.height = '';
                layoutAll();
            }
        };
        window.addEventListener('resize', function(){ layoutAll(); });

        // --- 2. 生成图片元素（基于抓取结果） ---
        function buildElements(items) {
            const elements = [];
            for (let i = 0; i < items.length; i++) {
                const it = items[i] || {};
                const width = 600;
                const height = (it.width && it.height) ? Math.round(width * (it.height / it.width)) : Math.floor(Math.random() * (800 - 400 + 1)) + 400;
                const url = it.url;
                const api = it.source || 'unknown';
                const dim = (it.width && it.height) ? `${it.width}x${it.height}` : `${width}x${height}`;

                const div = document.createElement('div');
                div.className = 'grid-item';
                div.innerHTML = `
                    <div class="img-container relative rounded-xl overflow-hidden bg-gray-800 cursor-pointer group" style="height:${height}px">
                        <div class="skeleton absolute inset-0 z-0"></div>
                        <img src="${url}" 
                             class="relative z-10 w-full block opacity-0 transition-opacity duration-700" 
                             loading="lazy"
                             data-api="${api}"
                             data-dim="${dim}"
                             onload="this.style.opacity=1; this.previousElementSibling.style.display='none'; if(window.__imgLoaded) __imgLoaded(this);"
                             onerror="this.parentElement.parentElement.style.display='none'" 
                        >
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20 flex items-center justify-center">
                            <span class="text-neon font-mono text-sm tracking-widest border border-neon px-3 py-1 rounded-full transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">VIEW DATA</span>
                        </div>
                    </div>
                `;
                elements.push(div);
            }
            return elements;
        }

        // --- 3. 加载逻辑 ---
        async function loadImages() {
            if (isLoading) return;
            isLoading = true;
            gsap.to('#loader', { opacity: 1, duration: 0.2 });
            document.getElementById('status-indicator').innerText = "FETCHING WALLPAPERS...";

            try {
                const orientation = (window.innerWidth > window.innerHeight) ? 'landscape' : 'portrait';
                const params = new URLSearchParams(location.search);
                const query = params.get('q') || '';
                const items = await window.fetchWallpapers({ count: CONFIG.batchSize, orientation, query, sources: ['unsplash','picsum'] });
                const newElems = buildElements(items);

                const fragment = document.createDocumentFragment();
                newElems.forEach(el => fragment.appendChild(el));
                grid.appendChild(fragment);
                layoutNew(newElems);
                gsap.fromTo(newElems,
                    { opacity: 0 },
                    { opacity: 1, duration: 0.8, stagger: 0.05, ease: "power2.out", onComplete: () => {
                        isLoading = false;
                        gsap.to('#loader', { opacity: 0, duration: 0.2 });
                        document.getElementById('status-indicator').innerText = "SYSTEM READY";
                    }}
                );
            } catch (e) {
                isLoading = false;
                gsap.to('#loader', { opacity: 0, duration: 0.2 });
                document.getElementById('status-indicator').innerText = "NETWORK ERROR";
            }
        }

        // --- 4. 无限滚动 (IntersectionObserver) ---
        // 这是修复滚动失效的关键。不用计算高度，而是看“哨兵”是否出现在屏幕里。
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                loadImages();
            }
        }, {
            rootMargin: '200px' // 距离底部200px时就开始加载，体验更丝滑
        });

        observer.observe(document.querySelector('#sentinel'));


        // --- 5. Lightbox 逻辑 (GSAP控制) ---
        const lightbox = document.querySelector('#lightbox');
        const lightboxImg = document.querySelector('#lightbox-img');
        const lightboxApi = document.querySelector('#lightbox-api');
        const lightboxDim = document.querySelector('#lightbox-dim');
        const closeBtn = document.querySelector('#close-btn');

        // 打开
        $(document).on('click', '.img-container', function() {
            const img = this.querySelector('img');
            
            // 设置内容
            lightboxImg.src = img.src;
            lightboxApi.innerText = img.dataset.api;
            lightboxDim.innerText = img.dataset.dim;

            // 动画显示 (autoAlpha: 1 等于 opacity: 1 + visibility: visible)
            gsap.to(lightbox, { autoAlpha: 1, duration: 0.3 });
            gsap.fromTo(lightboxImg, 
                { scale: 0.9, opacity: 0 }, 
                { scale: 1, opacity: 1, duration: 0.5, ease: "back.out(1.5)" }
            );
        });

        // 关闭函数
        function closeLightbox() {
            gsap.to(lightbox, { autoAlpha: 0, duration: 0.3 });
        }

        // 绑定关闭事件
        closeBtn.addEventListener('click', closeLightbox);
        
        // 点击背景关闭
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) closeLightbox();
        });

        // ESC 键关闭
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

    </script>
</body>
</html>