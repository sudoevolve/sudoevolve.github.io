。<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusFlow V2 - 修复增强版</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f0f11',
                        neon: '#00f3ff'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #0f0f11;
            color: white;
            overflow-x: hidden; /* 防止水平滚动 */
        }

        /* 隐藏 Lightbox 初始状态，交由 GSAP 控制 */
        #lightbox {
            visibility: hidden;
            opacity: 0;
        }

        .grid-item {
            width: calc(50% - 16px);
            margin-bottom: 24px;
            opacity: 0; /* 初始不可见，等待动画 */
        }

        @media (min-width: 768px) { .grid-item { width: calc(33.333% - 16px); } }
        @media (min-width: 1280px) { .grid-item { width: calc(20% - 16px); } }

        .img-container {
            transform-style: preserve-3d;
            transition: transform 0.3s ease-out;
        }
        .img-container:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 243, 255, 0.2);
            z-index: 10;
        }

        /* 骨架屏动画 */
        .skeleton {
            background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="antialiased">

    <nav class="fixed top-0 w-full z-50 backdrop-blur-xl bg-black/60 border-b border-white/10 py-4 px-6 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-neon rounded-full animate-pulse shadow-[0_0_10px_#00f3ff]"></div>
            <h1 class="text-xl font-bold tracking-widest">NEXUS<span class="text-neon">FLOW</span></h1>
        </div>
        <div id="status-indicator" class="text-[10px] text-neon font-mono border border-neon/30 px-2 py-1 rounded">
            SYSTEM READY
        </div>
    </nav>

    <main class="container mx-auto px-4 pt-24 pb-10 min-h-screen flex flex-col">
        <!-- 瀑布流容器 -->
        <div id="gallery" class="w-full relative">
            <div class="grid-sizer hidden"></div>
        </div>
        
        <!-- 加载动画 -->
        <div id="loader" class="w-full py-12 flex flex-col justify-center items-center transition-opacity duration-300 opacity-0">
            <div class="w-10 h-10 border-4 border-neon border-t-transparent rounded-full animate-spin"></div>
            <span class="mt-3 text-xs text-gray-500 font-mono">FETCHING DATA STREAMS...</span>
        </div>

        <!-- 哨兵元素：当滚动到这里时触发加载 -->
        <div id="sentinel" class="w-full h-10"></div>
    </main>

    <!-- Lightbox (全屏查看) -->
    <div id="lightbox" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-sm flex justify-center items-center p-4">
        <!-- 关闭按钮 -->
        <button id="close-btn" class="absolute top-6 right-6 text-white/50 hover:text-neon transition-colors z-50 p-2">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <div class="relative max-w-7xl w-full h-full flex flex-col items-center justify-center">
            <img id="lightbox-img" src="" class="max-h-[85vh] max-w-full object-contain rounded-lg shadow-[0_0_100px_-20px_rgba(0,243,255,0.3)]" alt="">
            
            <!-- 信息条 -->
            <div class="mt-6 flex items-center gap-6 bg-white/5 border border-white/10 px-8 py-3 rounded-full backdrop-blur-md">
                <div class="text-left">
                    <p class="text-[10px] text-gray-400 uppercase">Source</p>
                    <p id="lightbox-api" class="text-neon font-bold font-mono text-sm">API</p>
                </div>
                <div class="w-px h-8 bg-white/10"></div>
                <div class="text-left">
                    <p class="text-[10px] text-gray-400 uppercase">Resolution</p>
                    <p id="lightbox-dim" class="text-white font-mono text-sm">Size</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JS 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // --- 配置 ---
        const CONFIG = {
            batchSize: 12,    // 每次加载数量
            gutter: 24,       // 间距
        };

        // 状态变量
        let isLoading = false;
        let msnry; // Masonry 实例

        // API 源
        const apiSources = [
            { name: 'Picsum', fn: (w, h) => `https://picsum.photos/id/${Math.floor(Math.random()*1000)}/${w}/${h}` },
            { name: 'LoremFlickr', fn: (w, h) => `https://loremflickr.com/${w}/${h}/cyberpunk,neon,tech?random=${Math.random()}` },
            { name: 'PlaceIMG', fn: (w, h) => `https://placeimg.com/${w}/${h}/tech?t=${Math.random()}` }
        ];

        // --- 1. 初始化 Masonry ---
        // 使用原生 JS 初始化，便于控制
        const grid = document.querySelector('#gallery');
        msnry = new Masonry(grid, {
            itemSelector: '.grid-item',
            columnWidth: '.grid-item',
            gutter: CONFIG.gutter,
            percentPosition: true,
            transitionDuration: 0 // 关闭 Masonry 自带动画，用 GSAP
        });

        // --- 2. 生成图片数据 ---
        function createElements(count) {
            let elements = [];
            for (let i = 0; i < count; i++) {
                const width = 600;
                const height = Math.floor(Math.random() * (800 - 400 + 1)) + 400; // 随机高度
                
                // 随机选择源 (优先用 Picsum 和 Flickr 因为比较稳)
                const source = apiSources[Math.floor(Math.random() * 2)]; 
                const url = source.fn(width, height);

                const div = document.createElement('div');
                div.className = 'grid-item';
                div.innerHTML = `
                    <div class="img-container relative rounded-xl overflow-hidden bg-gray-800 cursor-pointer group">
                        <div class="skeleton absolute inset-0 z-0"></div>
                        <img src="${url}" 
                             class="relative z-10 w-full block opacity-0 transition-opacity duration-700" 
                             loading="lazy"
                             data-api="${source.name}"
                             data-dim="${width}x${height}"
                             onload="this.style.opacity=1; this.previousElementSibling.style.display='none';"
                             onerror="this.parentElement.parentElement.style.display='none'" 
                        >
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20 flex items-center justify-center">
                            <span class="text-neon font-mono text-sm tracking-widest border border-neon px-3 py-1 rounded-full transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">VIEW DATA</span>
                        </div>
                    </div>
                `;
                elements.push(div);
            }
            return elements;
        }

        // --- 3. 加载逻辑 ---
        function loadImages() {
            if (isLoading) return;
            isLoading = true;
            
            // 显示 Loading
            gsap.to('#loader', { opacity: 1, duration: 0.2 });
            document.getElementById('status-indicator').innerText = "DOWNLOADING...";

            // 模拟一点点延迟，让动画更自然
            setTimeout(() => {
                const newElems = createElements(CONFIG.batchSize);
                
                // 1. 先把元素加入 DOM
                const fragment = document.createDocumentFragment();
                newElems.forEach(el => fragment.appendChild(el));
                grid.appendChild(fragment);

                // 2. 追加给 Masonry
                msnry.appended(newElems);

                // 3. 等待这批图片下载完成（或者失败）再重新布局
                // 这是一个关键点：imagesLoaded 确保图片有高度了再布局，防止重叠
                imagesLoaded(grid, function() {
                    msnry.layout();
                    
                    // 4. GSAP 入场动画
                    gsap.to(newElems, {
                        opacity: 1,
                        y: 0,
                        duration: 0.8,
                        stagger: 0.05,
                        ease: "power2.out",
                        onComplete: () => {
                            isLoading = false;
                            gsap.to('#loader', { opacity: 0, duration: 0.2 });
                            document.getElementById('status-indicator').innerText = "SYSTEM READY";
                        }
                    });
                });
            }, 500);
        }

        // --- 4. 无限滚动 (IntersectionObserver) ---
        // 这是修复滚动失效的关键。不用计算高度，而是看“哨兵”是否出现在屏幕里。
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                loadImages();
            }
        }, {
            rootMargin: '200px' // 距离底部200px时就开始加载，体验更丝滑
        });

        observer.observe(document.querySelector('#sentinel'));


        // --- 5. Lightbox 逻辑 (GSAP控制) ---
        const lightbox = document.querySelector('#lightbox');
        const lightboxImg = document.querySelector('#lightbox-img');
        const lightboxApi = document.querySelector('#lightbox-api');
        const lightboxDim = document.querySelector('#lightbox-dim');
        const closeBtn = document.querySelector('#close-btn');

        // 打开
        $(document).on('click', '.img-container', function() {
            const img = this.querySelector('img');
            
            // 设置内容
            lightboxImg.src = img.src;
            lightboxApi.innerText = img.dataset.api;
            lightboxDim.innerText = img.dataset.dim;

            // 动画显示 (autoAlpha: 1 等于 opacity: 1 + visibility: visible)
            gsap.to(lightbox, { autoAlpha: 1, duration: 0.3 });
            gsap.fromTo(lightboxImg, 
                { scale: 0.9, opacity: 0 }, 
                { scale: 1, opacity: 1, duration: 0.5, ease: "back.out(1.5)" }
            );
        });

        // 关闭函数
        function closeLightbox() {
            gsap.to(lightbox, { autoAlpha: 0, duration: 0.3 });
        }

        // 绑定关闭事件
        closeBtn.addEventListener('click', closeLightbox);
        
        // 点击背景关闭
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) closeLightbox();
        });

        // ESC 键关闭
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

    </script>
</body>
</html>